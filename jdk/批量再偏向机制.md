# 批量再偏向机制

该机制的主要工作原理如下：

引入一个概念 epoch, 其本质是一个时间戳 ， 代表了偏向锁的有效性
从前文描述的对象头结构中可以看到， epoch 存储在可偏向对象的 MarkWord 中。
除了对象中的 epoch, 对象所属的类 class 信息中， 也会保存一个 epoch 值

每当遇到一个全局安全点时， 如果要对 class C 进行批量再偏向， 则首先对 class C 中保存的 epoch 进行增加操作， 得到一个新的 epoch_new

然后扫描所有持有 class C 实例的线程栈， 根据线程栈的信息判断出该线程是否锁定了该对象， 仅将 epoch_new 的值赋给被锁定的对象中。

退出安全点后， 当有线程需要尝试获取偏向锁时， 直接检查 class C 中存储的 epoch 值是否与目标对象中存储的 epoch 值相等， 如果不相等， 则说明该对象的偏向锁已经失效了， 可以直接通过 CAS 操作尝试再次将该对象再次偏向于请求获得锁的线程。




直接看到jvm源码里，做个记录

1: 得到当前的系统时间
2: 对kclass的对象头中设置当前时间
3: 如果需要批量再偏向
	3.1 如果klass的对象头中有偏向记录
	
	
	



查看jvm源码的monitorenter
先查看当前线程的






















